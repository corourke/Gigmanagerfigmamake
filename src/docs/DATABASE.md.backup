# Database Specification

## Overview

The database uses PostgreSQL 15+ with Prisma ORM for type-safe database access. All enum types are defined in the Prisma schema as the single source of truth.

## High-Level Entity Diagram

```mermaid
erDiagram
  ORGANIZATIONS ||--o{ ORGANIZATION_MEMBERS : has
  USERS ||--o{ ORGANIZATION_MEMBERS : belongs

  GIGS ||--o{ GIG_STATUS_HISTORY : has

  GIGS ||--o{ GIG_PARTICIPANTS : links
  ORGANIZATIONS ||--o{ GIG_PARTICIPANTS : linked_in
  GIGS ||--o{ GIG_STAFF_SLOTS : has
  ORGANIZATIONS ||--o{ GIG_STAFF_SLOTS : owns
  STAFF_ROLES ||--o{ GIG_STAFF_SLOTS : defines

  GIG_STAFF_SLOTS ||--o{ GIG_STAFF_ASSIGNMENTS : assigned
  USERS ||--o{ GIG_STAFF_ASSIGNMENTS : assigned_to
  GIGS ||--o{ GIG_BIDS : has
  ORGANIZATIONS ||--o{ GIG_BIDS : owns

  ORGANIZATIONS ||--o{ ASSETS : owns
```

## Enum Types

All database enum types are defined in Prisma schema:

```prisma
enum OrganizationType {
  Production
  Sound
  Lighting
  Staging
  Rentals
  Venue
  Act
  Agency
}

enum UserRole {
  Admin
  Manager
  Staff
  Viewer
}

enum GigStatus {
  DateHold
  Proposed
  Booked
  Completed
  Cancelled
  Settled
}
```

## Core Tables

### users

User profiles (extends Supabase auth.users)

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key, references auth.users(id) |
| first_name | TEXT | User's first name |
| last_name | TEXT | User's last name |
| email | TEXT | User's email address (unique) |
| phone | TEXT | User's phone number (nullable) |
| avatar_url | TEXT | URL to user's avatar image (nullable) |
| address_line1 | TEXT | Street address (nullable) |
| address_line2 | TEXT | Apartment, suite, etc. (nullable) |
| city | TEXT | City (nullable) |
| state | TEXT | State or province (nullable) |
| postal_code | TEXT | ZIP/postal code (nullable) |
| country | TEXT | Country (nullable) |
| role_hint | TEXT | Default staffing role hint (e.g., "FOH", "Lighting") (nullable) |
| created_at | TIMESTAMPTZ | Record creation timestamp |
| updated_at | TIMESTAMPTZ | Record last update timestamp |

**Notes:**
- Address fields structured to support both US and international addresses
- `created_by` and `updated_by` fields in other models reference User.id but don't maintain reverse relations

### organizations

Companies, venues, acts, and other entities

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| name | TEXT | Organization name |
| type | OrganizationType | Organization type enum |
| url | TEXT | Organization website URL (nullable) |
| phone_number | TEXT | Organization phone number (nullable) |
| address_line1 | TEXT | Street address (nullable) |
| address_line2 | TEXT | Apartment, suite, etc. (nullable) |
| city | TEXT | City (nullable) |
| state | TEXT | State or province (nullable) |
| postal_code | TEXT | ZIP/postal code (nullable) |
| country | TEXT | Country (nullable) |
| description | TEXT | Organization description (nullable), can be auto-filled from Google Places API |
| created_at | TIMESTAMPTZ | Record creation timestamp |
| updated_at | TIMESTAMPTZ | Record last update timestamp |

**Notes:**
- Primary contact information stored as organization-private data in `org_annotations`
- Ownership/editing permissions controlled via `OrganizationMember` with Admin role
- All authenticated users may read organizations, but only Admin members can modify

### organization_members

User memberships in organizations with roles

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| organization_id | UUID | Reference to organizations.id |
| user_id | UUID | Reference to users.id |
| role | UserRole | RBAC role within organization: Admin, Manager, Staff, Viewer |
| created_at | TIMESTAMPTZ | Record creation timestamp |

**Notes:**
- Admin members have full editing permissions for the organization
- Only Admin members can modify organization records


## Gig Management Tables

### gigs

Main gig records with status, dates, and details

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| title | TEXT | Gig title/name |
| status | GigStatus | Gig status enum: DateHold, Proposed, Booked, Completed, Cancelled, Settled |
| tags | TEXT[] | Array of tags for categorization (multi-select) |
| start | TIMESTAMPTZ | Start date and time of the gig |
| end | TIMESTAMPTZ | End date and time of the gig (gigs can span midnight) |
| timezone | TEXT | IANA timezone identifier (e.g., "America/New_York") |
| amount_paid | DECIMAL(10,2) | Total revenue collected for this gig (nullable) |
| notes | TEXT | Long text field for freeform notes (Markdown-formatted, nullable) |
| created_by | UUID | Reference to users.id (informational only, no relation) |
| updated_by | UUID | Reference to users.id (informational only, no relation) |
| created_at | TIMESTAMPTZ | Record creation timestamp |
| updated_at | TIMESTAMPTZ | Record last update timestamp |

**Notes:**
- Gigs are shared (participated in) by multiple organizations so there is no 'owning' organization. 
- The "gig date" shown in UI is derived from the start DateTime
- Gigs can span midnight, so we use full DateTime for both start and end
- `created_by` and `updated_by` are stored as User.id values but don't maintain reverse relations

### gig_status_history

Automatic audit log of status changes

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| gig_id | UUID | Reference to gigs.id |
| from_status | GigStatus | Previous status (nullable if initial status) |
| to_status | GigStatus | New status |
| changed_by | UUID | Reference to users.id (informational only) |
| changed_at | TIMESTAMPTZ | Status change timestamp |

**Notes:**
- `changed_by` is stored as User.id but doesn't maintain a reverse relation
- All status transitions are recorded for auditability
- **Status transitions: Any status can transition to any other status (no restrictions)**

### gig_participants

Organizations participating in a gig (venue, act, production, etc.)

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| organization_id | UUID | Reference to organizations.id (the participating organization) |
| gig_id | UUID | Reference to gigs.id |
| role | OrganizationType | Participant role using OrganizationType enum values |
| notes | TEXT | Long text field for freeform notes (Markdown-formatted, nullable) |

**Notes:**
- `role` uses the same OrganizationType enum values: Production, Sound, Lighting, Staging, Rentals, Venue, Act, Agency
- Both `gig_id` and `organization_id` are foreign keys

## Bid Management

### gig_bids

Bid tracking for gigs

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| organization_id | UUID | Reference to organizations.id (the owning organization) |
| gig_id | UUID | Reference to gigs.id |
| amount | DECIMAL(10,2) | Bid/proposal amount |
| date_given | DATE | Date the bid was given |
| result | TEXT | Bid result: Pending, Accepted, Rejected, Withdrawn (nullable) |
| notes | TEXT | Notes about the bid (nullable, Markdown-formatted) |
| created_by | UUID | Reference to users.id (informational only, no relation) |
| created_at | TIMESTAMPTZ | Record creation timestamp |

**Notes:**
- `created_by` is stored as User.id but doesn't maintain a reverse relation

## Staff Management Tables

### staff_roles

Global staff role choices (FOH, Lighting, etc.)

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| name | TEXT | Staff role name (e.g., "FOH", "Lighting", "Stage", "CameraOp") (unique) |
| description | TEXT | Description of the staff role and responsibilities (nullable) |
| created_at | TIMESTAMPTZ | Record creation timestamp |

**Notes:**
- Staff roles are enumerated in this table to support future staffing template functionality
- Templates can be created for different gig types based on gig tags

### gig_staff_slots

Staff positions needed for a gig

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| organization_id | UUID | Reference to organizations.id (the owning organization) |
| gig_id | UUID | Reference to gigs.id |
| staff_role_id | UUID | Reference to staff_roles.id (enumerated staff role for template support) |
| required_count | INTEGER | Number of people needed for this role |
| notes | TEXT | Notes about this staff need (nullable, Markdown-formatted) |
| created_at | TIMESTAMPTZ | Record creation timestamp |
| updated_at | TIMESTAMPTZ | Record last update timestamp |

**Notes:**
- Staff roles are enumerated via reference to staff_roles table
- This enables future staffing template functionality based on gig tags

### gig_staff_assignments

Actual staff assigned to positions

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| slot_id | UUID | Reference to gig_staff_slots.id |
| user_id | UUID | Reference to users.id |
| status | TEXT | Assignment status (e.g., "Confirmed", "Requested", "Declined") |
| rate | DECIMAL(10,2) | Hourly or daily rate for this assignment (nullable) |
| fee | DECIMAL(10,2) | Total fee for this assignment (nullable) |
| notes | TEXT | Notes about this assignment (nullable, Markdown-formatted) |
| assigned_at | TIMESTAMPTZ | Assignment timestamp |
| confirmed_at | TIMESTAMPTZ | Confirmation timestamp (nullable) |

**Notes:**
- User relation is through GigStaffSlot, not directly to Gig
- There is no direct relation between User and GigStaffAssignments (only through GigStaffSlots)

## Equipment

### assets

Equipment and asset management

| Field | Type | Description |
|-------|------|-------------|
| id | UUID | Primary key |
| organization_id | UUID | Reference to organizations.id (tenant that owns this asset) |
| acquisition_date | DATE | Date asset was acquired |
| vendor | TEXT | Vendor from which asset was purchased (nullable) |
| cost | DECIMAL(10,2) | Purchase cost of asset (nullable) |
| category | TEXT | Asset category (e.g., "Audio", "Lighting", "Video") |
| sub_category | TEXT | Asset sub-category (nullable) |
| insurance_policy_added | BOOLEAN | Whether asset has been added to insurance policy (default false) |
| manufacturer_model | TEXT | Manufacturer and model information |
| type | TEXT | Asset type (nullable) |
| serial_number | TEXT | Asset serial number (nullable) |
| description | TEXT | Long text description of asset (Markdown-formatted, nullable) |
| replacement_value | DECIMAL(10,2) | Replacement value for insurance purposes (nullable) |
| created_by | UUID | Reference to users.id (informational only, no relation) |
| updated_by | UUID | Reference to users.id (informational only, no relation) |
| created_at | TIMESTAMPTZ | Record creation timestamp |
| updated_at | TIMESTAMPTZ | Record last update timestamp |

**Notes:**
- `created_by` and `updated_by` are stored as user.id values but don't maintain reverse relations
- `description` is a long text field that can contain Markdown-formatted content
- Assets are owned by a tenant organization via `organization_id` for RLS and filtering

## Key Points

- Each first-class entity owned by the tenant has `organization_id` for RLS and filtering
- Gigs are shared (participated in) by multiple organizations so there is no 'owning' organization.
- Organizations are editable only by their Admin members (via `OrganizationMember` with `Admin` role)
- Gigs link to organizations via `gig_participants` with a `role` using OrganizationType enum values

- Tenant organizations can attach private notes/tags (scoped to the creating organization) to any organization via `org_annotations`
- Primary contact information for organizations is stored as organization-private data in `org_annotations`

- All Notes fields store Markdown-formatted text
- Gig status transitions recorded in `gig_status_history` for auditability
- `created_by` and `updated_by` fields throughout the schema store User.id values but don't maintain reverse relations (they're informational only)
- No indexes are created on primary key IDs (UUIDs) - PostgreSQL handles this automatically

## Row-Level Security (RLS)

### Access Control Requirements

- Users can only see gigs where there is an intersection of their organizational membership (via `organization_members`) and organizational participation with the gig (via `gig_participants`)
- RLS policies must be implemented on all tables
- Ensure data isolation between organizations
- Admin users have broader access within their organization

### RLS Policy Rules

**SELECT:**
- Users can read records where organization_id = the current organization context
- Organizations are readable by all authenticated users
- Annotations are only visible to the creating organization

**INSERT:**
- Users can create records for their organization
- Role must be Admin or Manager for most entities
- Staff can create limited records (assignments, notes)

**UPDATE:**
- Users can update records belonging to their organization
- Role permissions enforced (Admin-only for org settings)
- Staff can update assigned gig status and notes

**DELETE:**
- Admin/Manager roles can delete records for their organization
- Staff and Viewer roles cannot delete
- Cascading deletes maintain referential integrity

### Implementation

RLS policies can be implemented using:
1. **Supabase RLS policies** - Database-level enforcement
2. **Prisma middleware** - Application-level enforcement
3. **Hybrid approach** - RLS for reads, middleware for complex writes

## Gig Lifecycle Details

### Status Transitions

- **Allowed transitions**: Any status can transition to any other status (no restrictions)
- **Booked** means client (primary contact usually) has accepted
- **On transition to Booked**: Send notification to assigned personnel so that they can confirm
- **All status changes** must be recorded in `gig_status_history` for auditability

### Validation Rules

**Gig Creation:**
- `title`: Required, 1-200 characters
- `start`: Required, valid TIMESTAMPTZ
- `end`: Required, must be after `start`
- `timezone`: Required, must be valid IANA timezone
- `status`: Required, must be valid enum value

**Asset Creation:**
- `category`: Required, 1-50 characters
- `acquisition_date`: Optional, must be valid date (past or today)
- `cost`: Optional, must be >= 0, max 2 decimal places
- `replacement_value`: Optional, must be >= 0, max 2 decimal places
- `serial_number`: Optional, must be unique per organization (if provided)

**Organization Creation:**
- `name`: Required, 1-200 characters
- `type`: Required, must be valid enum value
- `email` (if contact): Must be valid email format

## Type System - Single Source of Truth

All database enum types are defined in Prisma schema and used as the single source of truth throughout the application. TypeScript types are automatically generated from Prisma and re-exported for use in the frontend.

### Adding New Enum Values

1. **Update Prisma schema** (`prisma/schema.prisma`)
2. **Run migration**: `npx prisma migrate dev --name add_new_value`
3. **Update component configs** (if needed) - TypeScript will error if you miss any required keys
4. **Regenerate Prisma Client**: Happens automatically with migrate

### Benefits

- **Maintainability**: Single place to update enum values
- **Type Safety**: TypeScript ensures consistency
- **No Sync Issues**: Generated types always match database
- **Clear Migration Path**: Schema changes are explicit in migrations

## Schema Migration Notes

### Key Schema Changes from Initial Design

**Organization Types:**
- Now includes: Production, Sound, Lighting, Staging, Rentals, Venue, Act, Agency
- Replaced compound names with single words (e.g., "ProductionCompany" â†’ "Production")

**Gig Status:**
- Uses DateHold instead of "Hold Date"
- Uses Settled instead of "Paid"
- PascalCase enum values for consistency

**Date/Time:**
- Gigs use `start` and `end` TIMESTAMPTZ fields (can span midnight)
- Combined date + time into single DateTime field
- Timezone stored separately as IANA identifier

**Participants:**
- Separate `gig_participants` table for flexible participant roles
- Replaced direct foreign keys (`venue_id`, `act_id`) with junction table
- Supports multiple participants of the same role type

## Related Documentation

- **API Endpoints**: See API.md for endpoint specifications
- **Requirements**: See ../REQUIREMENTS.md for feature requirements
- **Tech Stack**: See ../TECH_STACK.md for database technology details
